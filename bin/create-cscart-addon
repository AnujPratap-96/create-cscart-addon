#!/usr/bin/env php
<?php

require __DIR__ . '/../../../autoload.php';

// ----------------------
// Helpers
// ----------------------
function toStudlyCase(string $value): string
{
    return str_replace(' ', '', ucwords(str_replace('_', ' ', $value)));
}

function create_dir(string $path): void
{
    if (!is_dir($path)) {
        mkdir($path, 0777, true);
    }
}

function create_file(string $path, string $content): void
{
    file_put_contents($path, $content);
}

// ----------------------
// Interactive Yes/No
// ----------------------
function askYesNo(string $question, bool $default = true): bool
{
    $yesNo = $default ? '[Y/n]' : '[y/N]';
    echo "{$question} {$yesNo}: ";
    $input = trim(fgets(STDIN));

    if ($input === '') {
        return $default;
    }

    return in_array(strtolower($input), ['y', 'yes']);
}

// ----------------------
// Input
// ----------------------
if ($argc < 2) {
    echo "❌ Please provide addon name\n";
    echo "Usage: create-cscart-addon <addon_name>\n";
    exit(1);
}

$addonId = $argv[1];

// Validation
if (!preg_match('/^[a-z_]+$/', $addonId)) {
    echo "❌ Invalid addon name\n";
    echo "✔ Only lowercase letters and underscore (_) allowed\n";
    exit(1);
}

$addonNamespace = toStudlyCase($addonId);
$root = getcwd() . DIRECTORY_SEPARATOR . $addonId;

// Prevent overwrite
if (file_exists($root)) {
    echo "❌ Folder already exists: {$addonId}\n";
    exit(1);
}

// ----------------------
// Folder structure
// ----------------------
$folders = [
    "app/addons/{$addonId}/controllers",
    "app/addons/{$addonId}/{$addonNamespace}Model",
    "app/addons/{$addonId}/{$addonNamespace}Controllers",
    "app/addons/{$addonId}/schemas",
    "app/addons/{$addonId}/src/HookHandlers",
    "design/backend/templates/addons/{$addonId}",
    "var/langs/en/addons",
    "var/themes_repository/responsive/{$addonId}",
];

foreach ($folders as $folder) {
    $create = askYesNo("Do you want to create folder: {$folder}?", true);
    if ($create) {
        create_dir($root . DIRECTORY_SEPARATOR . $folder);
        echo "✔ Created: {$folder}\n";
    } else {
        echo "❌ Skipped: {$folder}\n";
    }
}

// ----------------------
// addon.xml
// ----------------------
$addonXmlContent = <<<XML
<?xml version="1.0"?>
<addon scheme="4.0">
    <id>{$addonId}</id>
    <version>1.0</version>
    <priority>1000</priority>
    <status>active</status>

    <autoload>
        <psr4 prefix="Tygh\\Addons\\{$addonNamespace}\\">src</psr4>
    </autoload>

    <bootstrap>Tygh\\Addons\\{$addonNamespace}\\Bootstrap</bootstrap>
    <installer>Tygh\\Addons\\{$addonNamespace}\\Installer</installer>
</addon>
XML;

if (askYesNo("Create addon.xml?", true)) {
    create_file("{$root}/app/addons/{$addonId}/addon.xml", $addonXmlContent);
    echo "✔ Created addon.xml\n";
}

// ----------------------
// Bootstrap.php content
// ----------------------
$bootstrapContent = <<<PHP
<?php

namespace Tygh\\Addons\\{$addonNamespace};

use Tygh\\Core\\ApplicationInterface;
use Tygh\\Core\\BootstrapInterface;
use Tygh\\Core\\HookHandlerProviderInterface;

class Bootstrap implements BootstrapInterface, HookHandlerProviderInterface
{
    public function boot(ApplicationInterface \$app)
    {
        \$app->register(new ServiceProvider());
    }

    public function getHookHandlerMap()
    {
        return [];
    }
}
PHP;

if (askYesNo("Create Bootstrap.php?", true)) {
    create_file("{$root}/app/addons/{$addonId}/src/Bootstrap.php", $bootstrapContent);
    echo "✔ Created Bootstrap.php\n";
}

// ----------------------
// Installer.php content
// ----------------------
$installerContent = <<<PHP
<?php

namespace Tygh\\Addons\\{$addonNamespace};

use Tygh\\Addons\\InstallerInterface;
use Tygh\\Core\\ApplicationInterface;

class Installer implements InstallerInterface
{
    public static function factory(ApplicationInterface \$app)
    {
        return new self();
    }

    public function onInstall()
    {
    }

    public function onUninstall()
    {
    }

    public function onBeforeInstall()
    {
    }
}
PHP;

if (askYesNo("Create Installer.php?", true)) {
    create_file("{$root}/app/addons/{$addonId}/src/Installer.php", $installerContent);
    echo "✔ Created Installer.php\n";
}

// ----------------------
// ServiceProvider.php content
// ----------------------
$serviceProviderContent = <<<PHP
<?php

namespace Tygh\\Addons\\{$addonNamespace};

use Pimple\\Container;
use Pimple\\ServiceProviderInterface;

class ServiceProvider implements ServiceProviderInterface
{
    public function register(Container \$app)
    {
        // Register services here
    }
}
PHP;

if (askYesNo("Create ServiceProvider.php?", true)) {
    create_file("{$root}/app/addons/{$addonId}/src/ServiceProvider.php", $serviceProviderContent);
    echo "✔ Created ServiceProvider.php\n";
}

// ----------------------
// BaseController.php content
// ----------------------
// ----------------------
// BaseController.php content
// ----------------------
$baseControllerContent = <<<PHP
<?php

namespace {$addonNamespace}Controllers;

use Tygh\\Registry;

class BaseController
{
    /**
     * @var mixed
     */
    public \$response;

    /**
     * @var string
     */
    protected \$mode;

    /**
     * @var string
     */
    protected \$requestMethod;

    /**
     * @var array
     */
    protected \$requestParam;

    /**
     * @var array
     */
    protected \$runMode = [];

    /**
     * BaseController constructor.
     *
     * @param string \$mode
     */
    public function __construct(\$mode)
    {
        \$this->mode = \$mode;
        \$this->requestParam = \$_REQUEST;
        \$this->requestMethod = \$_SERVER['REQUEST_METHOD'];
    }

    /**
     * @param array|string \$runMode
     */
    protected function setRunMode(\$runMode = [])
    {
        if (is_array(\$runMode)) {
            \$this->runMode = array_unique(\$runMode);
        } else {
            \$this->runMode[] = \$runMode;
            \$this->runMode = array_unique(\$this->runMode);
        }
    }
}
PHP;

if (askYesNo("Create BaseController.php?", true)) {
    create_file(
        "{$root}/app/addons/{$addonId}/{$addonNamespace}Controllers/BaseController.php",
        $baseControllerContent
    );
    echo "✔ Created BaseController.php\n";
}

// ----------------------
// BaseModel.php content (DO NOT MODIFY LOGIC)
// ----------------------
$baseModelContent = <<<PHP
<?php

namespace {$addonNamespace}Model;

use Exception;

class BaseModel
{

    private \$data;

    private \$logId;

    protected \$auth;

    public function __construct()
    {
        \$this->logId = TIME;
    }

    public function __set(\$varName, \$value)
    {
        \$this->data[\$varName] = \$value;
    }

    public function select(\$table, \$selection, \$where = [], \$func = 'db_get_array')
    {
        \$selection = (is_array(\$selection)) ? implode(",", \$selection) : \$selection;
        \$query = "SELECT \$selection FROM ?:\$table";
        if (!empty(\$where)) {
            \$query .= " WHERE 1 ";
            foreach (\$where as \$column => \$values) {
                if (is_array(\$values)) {
                    if (\$this->checkWhereClause(\$values[1])) {
                        \$value = "('" . implode("', '", \$values[0]) . "')";
                    } else {
                        \$value = \$this->checkIsString(\$values[0]);
                    }
                    \$constraint = \$values[1];
                } else {
                    \$value = \$this->checkIsString(\$values);
                    \$constraint = '=';
                }
                \$query .= "AND \$column \$constraint \$value ";
            }
        }
        try {
            return \$func(\$query);
        } catch (Exception \$e) {
            \$this->writeLog(MYSQL_ERROR_LOG, \$e->getMessage());
        }
    }

    public function insert(\$table, \$params)
    {
        \$query = "INSERT INTO ?:\$table ?e";
        try {
            return db_query(\$query, \$params);
        } catch (Exception \$e) {
            \$this->writeLog(MYSQL_ERROR_LOG, \$e->getMessage());
        }
    }

    public function replace(\$table, \$params)
    {
        \$query = "REPLACE INTO ?:\$table ?e";
        try {
            db_query(\$query, \$params);
        } catch (Exception \$e) {
            \$this->writeLog(MYSQL_ERROR_LOG, \$e->getMessage());
        }
    }

    public function update(\$table, \$params, \$where = [])
    {
        \$query = "UPDATE ?:\$table SET ?u";
        if (!empty(\$where)) {
            \$query .= " WHERE 1 ";
            foreach (\$where as \$column => \$value) {
                if (is_array(\$value)) {
                    \$assignValue = \$this->checkIsString(\$value[0]);
                    \$constraint = \$value[1];
                } else {
                    \$assignValue = \$this->checkIsString(\$value);
                    \$constraint = '=';
                }
                \$query .= "AND `\$column` \$constraint \$assignValue ";
            }
        }
        try {
            db_query(\$query, \$params);
        } catch (Exception \$e) {
            \$this->writeLog(MYSQL_ERROR_LOG, \$e->getMessage());
        }
    }

    public function delete(\$table, \$where = [])
    {
        \$query = "DELETE FROM ?:\$table";
        if (!empty(\$where)) {
            \$query .= " WHERE ";
            foreach (\$where as \$column => \$value) {
                if (is_array(\$value)) {
                    \$value = \$this->checkIsString(\$value[0]);
                    \$constraint = \$value[1];
                } else {
                    \$value = \$this->checkIsString(\$value);
                    \$constraint = '=';
                }
                \$query .= "\$column \$constraint \$value";
            }
            try {
                db_query(\$query);
            } catch (Exception \$e) {
                \$this->writeLog(MYSQL_ERROR_LOG, \$e->getMessage());
            }
        }
    }

    public function deleteAll(\$table)
    {
        \$query = "truncate table ?:\$table";
        try {
            db_query(\$query);
        } catch (Exception \$e) {
            \$this->writeLog(MYSQL_ERROR_LOG, \$e->getMessage());
        }
    }

    private function checkIsString(\$value)
    {
        return (is_string(\$value)) ? "\"\$value\"" : \$value;
    }

    public function writeLog(\$file, \$contents)
    {
        \$file = fopen(\$file, "a+");
        \$contents = \$this->logId . " " . date("Y-m-d h:i:s", TIME) . " " . \$contents . "\\n";
        fwrite(\$file, \$contents);
        fclose(\$file);
    }

    private function checkWhereClause(\$value)
    {
        \$allowedClause = ['NOT IN', 'IN'];
        return in_array(\$value, \$allowedClause);
    }

    public function manualQuery(\$query, \$func)
    {
        return \$func(\$query);
    }
}
PHP;

if (askYesNo("Create BaseModel.php?", true)) {
    create_file(
        "{$root}/app/addons/{$addonId}/{$addonNamespace}Model/BaseModel.php",
        $baseModelContent
    );
    echo "✔ Created BaseModel.php\n";
}



// ----------------------
// Language file content
// ----------------------
$langContent = <<<PO
msgid ""
msgstr ""
"Project-Id-Version: {$addonId}\\n"
"Language: en\\n"
"MIME-Version: 1.0\\n"
"Content-Type: text/plain; charset=UTF-8\\n"
"Content-Transfer-Encoding: 8bit\\n"

# Example translations
msgid "hello"
msgstr "Hello"

msgid "welcome_message"
msgstr "Welcome to our addon!"
PO;

if (askYesNo("Create language file {$addonId}.po?", true)) {
    create_file("{$root}/var/langs/en/addons/{$addonId}.po", $langContent);
    echo "✔ Created {$addonId}.po\n";
}

echo "✅ CS-Cart addon scaffold created: {$addonId}\n";
