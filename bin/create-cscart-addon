#!/usr/bin/env php
<?php

require __DIR__ . '/../../../autoload.php';

// ----------------------
// Helpers
// ----------------------
function toStudlyCase(string $value): string
{
    return str_replace(' ', '', ucwords(str_replace('_', ' ', $value)));
}

function create_dir(string $path): void
{
    if (!is_dir($path)) {
        mkdir($path, 0777, true);
    }
}

function create_file(string $path, string $content): void
{
    file_put_contents($path, $content);
}

// ----------------------
// Interactive Yes/No
// ----------------------
function askYesNo(string $question, bool $default = true): bool
{
    $yesNo = $default ? '[Y/n]' : '[y/N]';
    echo "{$question} {$yesNo}: ";
    $input = trim(fgets(STDIN));

    if ($input === '') {
        return $default;
    }

    return in_array(strtolower($input), ['y', 'yes']);
}

// ----------------------
// Input
// ----------------------
if ($argc < 2) {
    echo "❌ Please provide addon name\n";
    echo "Usage: create-cscart-addon <addon_name>\n";
    exit(1);
}

$addonId = $argv[1];

// Validation
if (!preg_match('/^[a-z_]+$/', $addonId)) {
    echo "❌ Invalid addon name\n";
    echo "✔ Only lowercase letters and underscore (_) allowed\n";
    exit(1);
}

$addonNamespace = toStudlyCase($addonId);
$root = getcwd() . DIRECTORY_SEPARATOR . $addonId;

// Prevent overwrite
if (file_exists($root)) {
    echo "❌ Folder already exists: {$addonId}\n";
    exit(1);
}

// ----------------------
// Folder structure
// ----------------------
$folders = [
    "app/addons/{$addonId}/controllers",
    "app/addons/{$addonId}/{$addonNamespace}Model",
    "app/addons/{$addonId}/{$addonNamespace}Controllers",
    "app/addons/{$addonId}/schema",
    "app/addons/{$addonId}/src/HookHandlers",
    "design/templates/addons/{$addonId}",
    "var/langs/en/addons",
    "var/themes_repository/{$addonId}",
];

foreach ($folders as $folder) {
    $create = askYesNo("Do you want to create folder: {$folder}?", true);
    if ($create) {
        create_dir($root . DIRECTORY_SEPARATOR . $folder);
        echo "✔ Created: {$folder}\n";
    } else {
        echo "❌ Skipped: {$folder}\n";
    }
}

// ----------------------
// addon.xml
// ----------------------
$addonXmlContent = <<<XML
<?xml version="1.0"?>
<addon scheme="4.0">
    <id>{$addonId}</id>
    <version>1.0</version>
    <priority>1000</priority>
    <status>active</status>

    <autoload>
        <psr4 prefix="Tygh\\Addons\\{$addonNamespace}\\">src</psr4>
    </autoload>

    <bootstrap>Tygh\\Addons\\{$addonNamespace}\\Bootstrap</bootstrap>
    <installer>Tygh\\Addons\\{$addonNamespace}\\Installer</installer>
</addon>
XML;

if (askYesNo("Create addon.xml?", true)) {
    create_file("{$root}/app/addons/{$addonId}/addon.xml", $addonXmlContent);
    echo "✔ Created addon.xml\n";
}

// ----------------------
// Bootstrap.php content
// ----------------------
$bootstrapContent = <<<PHP
<?php

namespace Tygh\\Addons\\{$addonNamespace};

use Tygh\\Core\\ApplicationInterface;
use Tygh\\Core\\BootstrapInterface;
use Tygh\\Core\\HookHandlerProviderInterface;

class Bootstrap implements BootstrapInterface, HookHandlerProviderInterface
{
    public function boot(ApplicationInterface \$app)
    {
        \$app->register(new ServiceProvider());
    }

    public function getHookHandlerMap()
    {
        return [];
    }
}
PHP;

if (askYesNo("Create Bootstrap.php?", true)) {
    create_file("{$root}/app/addons/{$addonId}/src/Bootstrap.php", $bootstrapContent);
    echo "✔ Created Bootstrap.php\n";
}

// ----------------------
// Installer.php content
// ----------------------
$installerContent = <<<PHP
<?php

namespace Tygh\\Addons\\{$addonNamespace};

use Tygh\\Addons\\InstallerInterface;
use Tygh\\Core\\ApplicationInterface;

class Installer implements InstallerInterface
{
    public static function factory(ApplicationInterface \$app)
    {
        return new self();
    }

    public function onInstall()
    {
    }

    public function onUninstall()
    {
    }

    public function onBeforeInstall()
    {
    }
}
PHP;

if (askYesNo("Create Installer.php?", true)) {
    create_file("{$root}/app/addons/{$addonId}/src/Installer.php", $installerContent);
    echo "✔ Created Installer.php\n";
}

// ----------------------
// ServiceProvider.php content
// ----------------------
$serviceProviderContent = <<<PHP
<?php

namespace Tygh\\Addons\\{$addonNamespace};

use Pimple\\Container;
use Pimple\\ServiceProviderInterface;

class ServiceProvider implements ServiceProviderInterface
{
    public function register(Container \$app)
    {
        // Register services here
    }
}
PHP;

if (askYesNo("Create ServiceProvider.php?", true)) {
    create_file("{$root}/app/addons/{$addonId}/src/ServiceProvider.php", $serviceProviderContent);
    echo "✔ Created ServiceProvider.php\n";
}

// ----------------------
// Language file content
// ----------------------
$langContent = <<<PO
msgid ""
msgstr ""
"Project-Id-Version: {$addonId}\\n"
"Language: en\\n"
"MIME-Version: 1.0\\n"
"Content-Type: text/plain; charset=UTF-8\\n"
"Content-Transfer-Encoding: 8bit\\n"

# Example translations
msgid "hello"
msgstr "Hello"

msgid "welcome_message"
msgstr "Welcome to our addon!"
PO;

if (askYesNo("Create language file en.po?", true)) {
    create_file("{$root}/var/langs/en/addons/en.po", $langContent);
    echo "✔ Created en.po\n";
}

echo "✅ CS-Cart addon scaffold created: {$addonId}\n";
